<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šç›´æ’­</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; }
        .video-container { width: 100%; height: 300px; background: #000; margin: 10px 0; }
        .controls { margin: 20px 0; text-align: center; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #1890ff; color: white; }
        .btn-danger { background: #ff4d4f; color: white; }
        .btn-success { background: #52c41a; color: white; }
        .live-list { margin: 20px 0; }
        .live-item { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 5px; }
        #localVideo, #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç›´æ’­åˆ—è¡¨é¡µ -->
        <div id="listPage" class="page active">
            <h2>ğŸ“º ä¼ä¸šç›´æ’­</h2>
            <div class="controls">
                <button class="btn btn-primary" onclick="createLive()">ğŸ¥ å‘èµ·ç›´æ’­</button>
                <button class="btn btn-success" onclick="refreshList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="liveList" class="live-list">
                <div class="live-item">
                    <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. ç‚¹å‡»"å‘èµ·ç›´æ’­"å¼€å§‹æ¨æµ</p>
                    <p>2. åˆ†äº«é“¾æ¥ç»™åŒäº‹è§‚çœ‹</p>
                    <p>3. çº¯å‰ç«¯å®ç°ï¼Œæ— éœ€æœåŠ¡å™¨</p>
                </div>
            </div>
        </div>

        <!-- ç›´æ’­æ¨æµé¡µ -->
        <div id="pushPage" class="page">
            <h2>ğŸ”´ æ­£åœ¨ç›´æ’­</h2>
            <div class="video-container">
                <video id="localVideo" autoplay muted></video>
            </div>
            <div class="controls">
                <button id="startBtn" class="btn btn-primary" onclick="startLive()">å¼€å§‹ç›´æ’­</button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopLive()" style="display:none">åœæ­¢ç›´æ’­</button>
                <button class="btn btn-success" onclick="shareLive()">ğŸ“¤ åˆ†äº«ç›´æ’­</button>
                <button class="btn" onclick="showPage('listPage')">è¿”å›åˆ—è¡¨</button>
            </div>
            <div id="liveInfo" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                <p><strong>ç›´æ’­é—´ID:</strong> <span id="channelName"></span></p>
                <p><strong>è§‚çœ‹äººæ•°:</strong> <span id="audienceCount">0</span></p>
            </div>
        </div>

        <!-- ç›´æ’­è§‚çœ‹é¡µ -->
        <div id="watchPage" class="page">
            <h2>ğŸ‘€ è§‚çœ‹ç›´æ’­</h2>
            <div class="video-container">
                <video id="remoteVideo" autoplay controls></video>
            </div>
            <div class="controls">
                <button id="joinBtn" class="btn btn-primary" onclick="joinLive()">åŠ å…¥è§‚çœ‹</button>
                <button id="leaveBtn" class="btn btn-danger" onclick="leaveLive()" style="display:none">é€€å‡ºè§‚çœ‹</button>
                <button class="btn" onclick="showPage('listPage')">è¿”å›åˆ—è¡¨</button>
            </div>
            <div id="watchInfo" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                <p><strong>ç›´æ’­é—´:</strong> <span id="watchChannelName"></span></p>
                <p><strong>çŠ¶æ€:</strong> <span id="liveStatus">ç­‰å¾…è¿æ¥...</span></p>
            </div>
        </div>
    </div>

    <script>
        // å£°ç½‘é…ç½® - æ›¿æ¢ä¸ºæ‚¨çš„AppID
        const AGORA_CONFIG = {
            appId: "e2d14f62ccd74c47a053b74175fa912b", // éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„å£°ç½‘AppID
            token: null // ç®€åŒ–ç‰ˆæœ¬ä¸ä½¿ç”¨tokenï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨
        };

        // ä¼ä¸šå¾®ä¿¡é…ç½® - æ›¿æ¢ä¸ºæ‚¨çš„ä¼ä¸šä¿¡æ¯
        const WEWORK_CONFIG = {
            corpId: "ww619439206ed8f40e",
            agentId: "1000002"
        };

        // å…¨å±€å˜é‡
        let agoraClient = null;
        let localTracks = [];
        let currentChannel = '';
        let isHost = false;

        // åº”ç”¨ä¸»ç±»
        class PureFrontendLive {
            constructor() {
                this.initApp();
            }

            async initApp() {
                // åˆå§‹åŒ–å£°ç½‘å®¢æˆ·ç«¯
                agoraClient = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
                
                // ç›‘å¬è¿œç¨‹ç”¨æˆ·
                agoraClient.on("user-published", this.handleUserPublished.bind(this));
                agoraClient.on("user-unpublished", this.handleUserUnpublished.bind(this));
                
                // åˆå§‹åŒ–ä¼ä¸šå¾®ä¿¡
                this.initWework();
                
                // æ£€æŸ¥URLå‚æ•°
                this.checkUrlParams();
            }

            initWework() {
                // ç®€åŒ–ç‰ˆä¼ä¸šå¾®ä¿¡é…ç½®ï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦åç«¯ç”Ÿæˆç­¾åï¼‰
                wx.config({
                    beta: true,
                    debug: false,
                    appId: WEWORK_CONFIG.corpId,
                    timestamp: Math.floor(Date.now() / 1000),
                    nonceStr: Math.random().toString(36).substr(2),
                    signature: 'temp_signature', // å®é™…éœ€è¦åç«¯è®¡ç®—
                    jsApiList: ['updateAppMessageShareData', 'updateTimelineShareData']
                });
            }

            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const channel = urlParams.get('channel');
                const mode = urlParams.get('mode');

                if (channel && mode === 'watch') {
                    this.watchLive(channel);
                }
            }

            // åˆ›å»ºç›´æ’­é—´
            async createLive() {
                const channelName = 'live_' + Date.now();
                currentChannel = channelName;
                isHost = true;
                
                document.getElementById('channelName').textContent = channelName;
                showPage('pushPage');
            }

            // å¼€å§‹ç›´æ’­
            async startLive() {
                try {
                    // è®¾ç½®ä¸ºä¸»æ’­è§’è‰²
                    await agoraClient.setClientRole("host");
                    
                    // åˆ›å»ºæœ¬åœ°éŸ³è§†é¢‘è½¨é“
                    localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
                    const [audioTrack, videoTrack] = localTracks;
                    
                    // æ’­æ”¾æœ¬åœ°è§†é¢‘
                    videoTrack.play('localVideo');
                    
                    // åŠ å…¥é¢‘é“
                    await agoraClient.join(AGORA_CONFIG.appId, currentChannel, AGORA_CONFIG.token);
                    
                    // å‘å¸ƒæœ¬åœ°æµ
                    await agoraClient.publish(localTracks);
                    
                    // æ›´æ–°UI
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    console.log('ç›´æ’­å¼€å§‹æˆåŠŸ');
                    this.updateLiveStatus('ç›´æ’­ä¸­...');
                    
                } catch (error) {
                    console.error('å¼€å§‹ç›´æ’­å¤±è´¥:', error);
                    alert('å¼€å§‹ç›´æ’­å¤±è´¥: ' + error.message);
                }
            }

            // åœæ­¢ç›´æ’­
            async stopLive() {
                try {
                    // åœæ­¢æœ¬åœ°è½¨é“
                    localTracks.forEach(track => {
                        track.stop();
                        track.close();
                    });
                    localTracks = [];
                    
                    // ç¦»å¼€é¢‘é“
                    await agoraClient.leave();
                    
                    // æ›´æ–°UI
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                    
                    console.log('ç›´æ’­åœæ­¢æˆåŠŸ');
                    this.updateLiveStatus('ç›´æ’­å·²ç»“æŸ');
                    
                } catch (error) {
                    console.error('åœæ­¢ç›´æ’­å¤±è´¥:', error);
                }
            }

            // è§‚çœ‹ç›´æ’­
            async watchLive(channelName = null) {
                if (!channelName) {
                    channelName = prompt('è¯·è¾“å…¥ç›´æ’­é—´ID:');
                    if (!channelName) return;
                }
                
                currentChannel = channelName;
                isHost = false;
                
                document.getElementById('watchChannelName').textContent = channelName;
                showPage('watchPage');
            }

            // åŠ å…¥è§‚çœ‹
            async joinLive() {
                try {
                    // è®¾ç½®ä¸ºè§‚ä¼—è§’è‰²
                    await agoraClient.setClientRole("audience");
                    
                    // åŠ å…¥é¢‘é“
                    await agoraClient.join(AGORA_CONFIG.appId, currentChannel, AGORA_CONFIG.token);
                    
                    // æ›´æ–°UI
                    document.getElementById('joinBtn').style.display = 'none';
                    document.getElementById('leaveBtn').style.display = 'inline-block';
                    document.getElementById('liveStatus').textContent = 'å·²è¿æ¥ï¼Œç­‰å¾…ä¸»æ’­...';
                    
                    console.log('åŠ å…¥ç›´æ’­æˆåŠŸ');
                    
                } catch (error) {
                    console.error('åŠ å…¥ç›´æ’­å¤±è´¥:', error);
                    alert('åŠ å…¥ç›´æ’­å¤±è´¥: ' + error.message);
                }
            }

            // é€€å‡ºè§‚çœ‹
            async leaveLive() {
                try {
                    await agoraClient.leave();
                    
                    // æ›´æ–°UI
                    document.getElementById('joinBtn').style.display = 'inline-block';
                    document.getElementById('leaveBtn').style.display = 'none';
                    document.getElementById('liveStatus').textContent = 'å·²æ–­å¼€è¿æ¥';
                    
                    // æ¸…ç©ºè§†é¢‘
                    document.getElementById('remoteVideo').srcObject = null;
                    
                } catch (error) {
                    console.error('é€€å‡ºè§‚çœ‹å¤±è´¥:', error);
                }
            }

            // åˆ†äº«ç›´æ’­
            shareLive() {
                const shareUrl = `${window.location.origin}${window.location.pathname}?channel=${currentChannel}&mode=watch`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('ç›´æ’­é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥åˆ†äº«ç»™åŒäº‹äº†ï¼');
                }).catch(() => {
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = shareUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('ç›´æ’­é“¾æ¥å·²å¤åˆ¶: ' + shareUrl);
                });

                // ä¼ä¸šå¾®ä¿¡åˆ†äº«ï¼ˆå¦‚æœåœ¨ä¼ä¸šå¾®ä¿¡ç¯å¢ƒä¸­ï¼‰
                if (typeof wx !== 'undefined') {
                    wx.ready(() => {
                        wx.updateAppMessageShareData({
                            title: 'ä¼ä¸šç›´æ’­',
                            desc: 'æ­£åœ¨ç›´æ’­ä¸­ï¼Œå¿«æ¥è§‚çœ‹ï¼',
                            link: shareUrl,
                            imgUrl: window.location.origin + '/logo.png',
                            success: () => console.log('ä¼ä¸šå¾®ä¿¡åˆ†äº«æˆåŠŸ')
                        });
                    });
                }
            }

            // å¤„ç†è¿œç¨‹ç”¨æˆ·å‘å¸ƒ
            async handleUserPublished(user, mediaType) {
                await agoraClient.subscribe(user, mediaType);
                
                if (mediaType === 'video') {
                    const remoteVideoTrack = user.videoTrack;
                    remoteVideoTrack.play('remoteVideo');
                    document.getElementById('liveStatus').textContent = 'æ­£åœ¨è§‚çœ‹ç›´æ’­';
                }
                
                if (mediaType === 'audio') {
                    const remoteAudioTrack = user.audioTrack;
                    remoteAudioTrack.play();
                }
            }

            // å¤„ç†è¿œç¨‹ç”¨æˆ·å–æ¶ˆå‘å¸ƒ
            handleUserUnpublished(user, mediaType) {
                if (mediaType === 'video') {
                    document.getElementById('remoteVideo').srcObject = null;
                    document.getElementById('liveStatus').textContent = 'ä¸»æ’­å·²ç¦»å¼€';
                }
            }

            updateLiveStatus(status) {
                const statusElements = document.querySelectorAll('#liveStatus');
                statusElements.forEach(el => el.textContent = status);
            }
        }

        // é¡µé¢åˆ‡æ¢å‡½æ•°
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
        let app;
        
        window.onload = function() {
            app = new PureFrontendLive();
        };

        function createLive() {
            app.createLive();
        }

        function startLive() {
            app.startLive();
        }

        function stopLive() {
            app.stopLive();
        }

        function joinLive() {
            app.joinLive();
        }

        function leaveLive() {
            app.leaveLive();
        }

        function shareLive() {
            app.shareLive();
        }

        function refreshList() {
            alert('è¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œå®é™…é¡¹ç›®å¯ä»¥ä»äº‘ç«¯æ‹‰å–ç›´æ’­åˆ—è¡¨');
        }
    </script>
</body>
</html>
